<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>SHOP BÃN HÃ€NG â€“ ERP May Máº·c (SPA)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="./style.css" rel="stylesheet" />
</head>
<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-icon">ğŸ“„</div>
      <div>
        <div class="brand-title">SHOP BÃN HÃ€NG</div>
        <div class="brand-sub">Quáº£n lÃ½ bÃ¡n hÃ ng offline</div>
      </div>
    </div>

    <div class="menu-group">
      <div class="menu-title">Tá»”NG QUAN</div>
      <a class="menu-item active" data-page="overview">ğŸ  Dashboard</a>
    </div>

    <div class="menu-group">
      <div class="menu-title">QUáº¢N LÃ CÆ  Báº¢N</div>
      <a class="menu-item" data-page="customers">ğŸ‘¤ KhÃ¡ch hÃ ng</a>
      <a class="menu-item" data-page="suppliers">ğŸ­ NhÃ  cung cáº¥p</a>
      <a class="menu-item" data-page="product">ğŸ“¦ Sáº£n pháº©m</a>
      <a class="menu-item" data-page="categories">ğŸ—‚ Danh má»¥c</a>
      <a class="menu-item" data-page="inventory">ğŸ“¦ Kho hÃ ng</a>
    </div>

    <div class="menu-group">
      <div class="menu-title">NGHIá»†P Vá»¤</div>
      <a class="menu-item" data-page="debts">ğŸ’³ CÃ´ng ná»£</a>
      <a class="menu-item" data-page="orders_view">ğŸ“‘ Quáº£n lÃ½ Ä‘Æ¡n hÃ ng</a>
      <a class="menu-item" data-page="order">ğŸ§¾ Táº¡o Ä‘Æ¡n má»›i</a>
      <a class="menu-item" data-page="manufacturing">ğŸ§µ Sáº£n xuáº¥t</a>
      <a class="menu-item" data-page="timesheet">ğŸ“ Cháº¥m cÃ´ng</a>
      <a class="menu-item" data-page="payroll">ğŸ’° TÃ­nh lÆ°Æ¡ng</a>
    </div>

    <div class="menu-group">
      <div class="menu-title">BÃO CÃO</div>
      <a class="menu-item" data-page="reports">ğŸ“Š BÃ¡o cÃ¡o</a>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main">
    <!-- TOPBAR -->
    <header class="topbar">
      <div class="top-title">Há»‡ thá»‘ng Quáº£n lÃ½</div>
      <div class="actions">
        <button class="chip success">ğŸŸ© PITC</button>
        <button class="btn primary" data-page="order">ğŸ§¾ ÄÆ¡n hÃ ng</button>
        <button class="btn danger">ğŸšª ÄÄƒng xuáº¥t</button>
      </div>
    </header>

    <!-- DASHBOARD SHELL (KPI + quick actions) -->
    <section class="content" id="dashboard-shell">
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-title">ÄÆ N HÃ€NG HÃ”M NAY</div>
          <div class="kpi-value" id="kpi_today_orders">0</div>
          <div class="kpi-sub">Tá»•ng: <span id="kpi_today_amount">0 VND</span></div>
        </div>
        <div class="kpi-card">
          <div class="kpi-title">ÄÆ N HÃ€NG TUáº¦N NÃ€Y</div>
          <div class="kpi-value" id="kpi_week_orders">0</div>
          <div class="kpi-sub">Tá»•ng: <span id="kpi_week_amount">0 VND</span></div>
        </div>
        <div class="kpi-card">
          <div class="kpi-title">ÄÆ N HÃ€NG THÃNG NÃ€Y</div>
          <div class="kpi-value" id="kpi_month_orders">0</div>
          <div class="kpi-sub">Tá»•ng: <span id="kpi_month_amount">0 VND</span></div>
        </div>
        <div class="kpi-card">
          <div class="kpi-title">Tá»”NG ÄÆ N HÃ€NG</div>
          <div class="kpi-value" id="kpi_all_orders">0</div>
          <div class="kpi-sub">Táº¥t cáº£ thá»i gian</div>
        </div>
      </div>

      <div class="card">
        <h3>Quáº£n lÃ½ Ä‘Æ¡n hÃ ng</h3>
        <div class="quick-grid">
          <button class="quick" data-page="order">
            <div class="q-icon">ğŸ“</div><div>Táº¡o Ä‘Æ¡n hÃ ng má»›i</div>
          </button>
          <button class="quick" data-page="orders_view">
            <div class="q-icon">ğŸ“…</div><div>ÄÆ¡n hÃ ng hÃ´m nay</div>
          </button>
          <button class="quick" data-page="orders_view">
            <div class="q-icon">ğŸ“ˆ</div><div>ÄÆ¡n hÃ ng tuáº§n</div>
          </button>
          <button class="quick" data-page="reports">
            <div class="q-icon">ğŸ“„</div><div>Xuáº¥t bÃ¡o cÃ¡o</div>
          </button>
        </div>
      </div>

      <div class="card">
        <div class="list-head">
          <h3>ğŸ“‹ Danh sÃ¡ch Ä‘Æ¡n hÃ ng</h3>
          <input class="search" id="search_orders" placeholder="TÃ¬m kiáº¿m theo mÃ£ Ä‘Æ¡n, khÃ¡ch hÃ ng..." />
        </div>
        <div id="orders_table_shell"></div>
      </div>
    </section>

    <!-- Dynamic app pages sáº½ render vÃ o Ä‘Ã¢y -->
    <main id="app"></main>

    <footer class="foot">Â© ERP May Máº·c â€” SPA mÆ°á»£t nhÆ° app</footer>
  </div>

  <script src="./script.js"></script>
  <script>
    /* ====== CÃ¡c tiá»‡n Ã­ch Ä‘á»™c láº­p Ä‘á»ƒ Dashboard shell tá»± cháº¡y Ä‘Æ°á»£c ====== */
    const API_URL = "/.netlify/functions/gas"; // giá»¯ Ä‘á»“ng bá»™ vá»›i script.js
    const fmtVND = (n) => (Number(n || 0)).toLocaleString("vi-VN") + " VND";

    async function _apiGet(sheet){
      const res = await fetch(\`\${API_URL}?sheet=\${encodeURIComponent(sheet)}\`);
      return res.json();
    }

    // KPI: Ä‘á»c tá»« DonHang theo khoáº£ng ngÃ y/tuáº§n/thÃ¡ng
    async function _loadKPI() {
      const rs = await _apiGet("DonHang");
      if (!rs.ok || !rs.rows?.length) return;
      const [h, ...rows] = rs.rows;
      const idx = {
        MaDon: h.indexOf("MaDon")>-1? h.indexOf("MaDon"): h.indexOf("MÃ£ Ä‘Æ¡n"),
        Ngay:  h.indexOf("NgayTao")>-1? h.indexOf("NgayTao"): h.indexOf("NgÃ y táº¡o"),
        Tong:  h.indexOf("TongTien")>-1? h.indexOf("TongTien"): h.indexOf("Tá»•ng tiá»n")
      };
      const today = new Date();
      const sameDay = (d) => d.toDateString() === today.toDateString();
      const sameWeek = (d) => {
        const diff = (today - d)/(1000*3600*24); return diff <= 7;
      };
      const sameMonth = (d) => d.getFullYear()===today.getFullYear() && d.getMonth()===today.getMonth();

      let cDay=0,sDay=0,cWeek=0,sWeek=0,cMonth=0,sMonth=0;
      rows.forEach(r=>{
        const d = new Date(r[idx.Ngay]);
        const t = Number(r[idx.Tong]||0);
        if (sameDay(d))  { cDay++;  sDay += t; }
        if (sameWeek(d)) { cWeek++; sWeek += t; }
        if (sameMonth(d)){ cMonth++; sMonth += t; }
      });

      document.getElementById("kpi_today_orders").textContent = cDay;
      document.getElementById("kpi_today_amount").textContent = fmtVND(sDay);
      document.getElementById("kpi_week_orders").textContent = cWeek;
      document.getElementById("kpi_week_amount").textContent = fmtVND(sWeek);
      document.getElementById("kpi_month_orders").textContent = cMonth;
      document.getElementById("kpi_month_amount").textContent = fmtVND(sMonth);
      document.getElementById("kpi_all_orders").textContent = rows.length;
    }

    // Báº£ng Ä‘Æ¡n hÃ ng trong Dashboard shell
    async function _loadOrdersShell(keyword="") {
      const rs = await _apiGet("DonHang");
      if (!rs.ok || !rs.rows?.length) {
        document.getElementById("orders_table_shell").innerHTML = "<div class='muted'>ChÆ°a cÃ³ dá»¯ liá»‡u</div>";
        return;
      }
      const [h, ...rows] = rs.rows;
      const idx = {
        MaDon: h.indexOf("MaDon")>-1? h.indexOf("MaDon"): h.indexOf("MÃ£ Ä‘Æ¡n"),
        Khach: h.indexOf("KhachHang")>-1? h.indexOf("KhachHang"): h.indexOf("KhÃ¡ch hÃ ng"),
        Ngay:  h.indexOf("NgayTao")>-1? h.indexOf("NgayTao"): h.indexOf("NgÃ y táº¡o"),
        Tong:  h.indexOf("TongTien")>-1? h.indexOf("TongTien"): h.indexOf("Tá»•ng tiá»n"),
        Paid:  h.indexOf("KhachTra")>-1? h.indexOf("KhachTra"): h.indexOf("KhÃ¡ch tráº£"),
        ConNo: h.indexOf("ConNo")>-1? h.indexOf("ConNo"): h.indexOf("CÃ²n ná»£")
      };
      const q = (keyword||"").toLowerCase();
      const data = rows.filter(r=>{
        if (!q) return true;
        return String(r[idx.MaDon]||"").toLowerCase().includes(q) ||
               String(r[idx.Khach]||"").toLowerCase().includes(q);
      });

      let html = "<table><thead><tr>" +
        "<th>MÃ£ Ä‘Æ¡n</th><th>KhÃ¡ch hÃ ng</th><th>NgÃ y</th>" +
        "<th class='right'>Tá»•ng</th><th class='right'>KhÃ¡ch tráº£</th><th class='right'>CÃ²n ná»£</th>" +
        "</tr></thead><tbody>";
      data.forEach(r=>{
        html += "<tr>" +
          `<td>${r[idx.MaDon]||""}</td>` +
          `<td>${r[idx.Khach]||""}</td>` +
          `<td>${r[idx.Ngay]||""}</td>` +
          `<td class="right">${fmtVND(r[idx.Tong]||0)}</td>` +
          `<td class="right">${fmtVND(r[idx.Paid]||0)}</td>` +
          `<td class="right">${fmtVND(r[idx.ConNo]||0)}</td>` +
          "</tr>";
      });
      html += "</tbody></table>";
      document.getElementById("orders_table_shell").innerHTML = html;
    }

    // Expose Ä‘á»ƒ Ã´ tÃ¬m kiáº¿m Dashboard gá»i lá»c
    window._filterOrdersShell = (kw) => _loadOrdersShell(kw);

    // Router hook tá»« script.js
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('[data-page]').forEach(el => {
        el.addEventListener('click', () => loadPage(el.dataset.page));
      });
      // VÃ o Dashboard: load KPI + báº£ng Ä‘Æ¡n hÃ ng trong shell
      _loadKPI();
      _loadOrdersShell();

      // TÃ¬m kiáº¿m trong shell
      const search = document.getElementById('search_orders');
      if (search) search.addEventListener('input', () => _loadOrdersShell(search.value || ''));
    });
  </script>
</body>
</html>
