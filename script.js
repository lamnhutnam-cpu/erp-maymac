/* ===================================================================
   ERP MAY M·∫∂C ‚Äì SPA Frontend (c√≥ c√¥ng n·ª£ khi t·∫°o h√≥a ƒë∆°n)
   =================================================================== */

/* =============== CONFIG =============== */
const API_URL = "/.netlify/functions/gas"; // proxy Netlify t·ªõi GAS
// const API_URL = "https://script.google.com/macros/s/XXXX/exec"; // d√πng tr·ª±c ti·∫øp n·∫øu kh√¥ng qua Netlify

/* =============== HELPERS =============== */
const $  = (s, el = document) => el.querySelector(s);
const $$ = (s, el = document) => Array.from(el.querySelectorAll(s));
const appEl   = () => $("#app");
const shellEl = () => $("#dashboard-shell");

const fmtVND = (n) => (Number(n || 0)).toLocaleString("vi-VN") + " VND";
const todayStr = () => {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${y}/${m}/${dd}`;
};
const toObjects = (headers, rows) => rows.map(r => {
  const o = {}; headers.forEach((h, i) => (o[h] = r[i])); return o;
});
function renderTableArray(headers, data) {
  if (!data?.length) return `<div class="muted">‚Äî</div>`;
  let html = `<table><thead><tr>${headers.map(h=>`<th>${h}</th>`).join("")}</tr></thead><tbody>`;
  data.forEach(row => {
    html += `<tr>${headers.map(h=>{
      const right = /SL|S·ªë l∆∞·ª£ng|ƒê∆°n gi√°|Th√†nh ti·ªÅn|T·ªïng|Ton|Gia|Amount|Qty|N·ª£|Tr·∫£/i.test(h) ? ' class="right"' : "";
      return `<td${right}>${row[h] ?? ""}</td>`;
    }).join("")}</tr>`;
  });
  html += `</tbody></table>`;
  return html;
}

/* =============== API =============== */
async function apiGet(sheet) {
  const res = await fetch(`${API_URL}?sheet=${encodeURIComponent(sheet)}`);
  return res.json();
}
async function apiPost(body) {
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json; charset=utf-8" },
    body: JSON.stringify(body),
  });
  return res.json();
}
/* C√¥ng n·ª£: h·ªèi n·ª£ hi·ªán t·∫°i c·ªßa 1 kh√°ch. N·∫øu backend ch∆∞a c√≥ action n√†y -> tr·∫£ 0 */
async function getDebt(khach) {
  try {
    const r = await apiPost({ action: "getDebt", khach });
    return r?.ok ? Number(r.debt || 0) : 0;
  } catch { return 0; }
}

/* =============== OFFLINE QUEUE =============== */
const SYNC_KEY = "erp_sync_queue_v2";
const getQueue = () => JSON.parse(localStorage.getItem(SYNC_KEY) || "[]");
const setQueue = (q) => localStorage.setItem(SYNC_KEY, JSON.stringify(q));
function toast(msg, type="info") {
  const t = document.createElement("div");
  Object.assign(t.style, {
    position:"fixed", right:"16px", bottom:"16px",
    background: type==="error"?"#d9534f": type==="success"?"#28a745":"#111",
    color:"#fff", padding:"10px 12px", borderRadius:"10px",
    boxShadow:"0 8px 22px rgba(0,0,0,.25)", zIndex:9999, fontSize:"14px"
  });
  t.textContent = msg; document.body.appendChild(t);
  setTimeout(()=> t.remove(), 2200);
}
async function safePost(body) {
  try {
    const r = await apiPost(body);
    if (!r.ok) throw new Error(r.error || "API error");
    return r;
  } catch (e) {
    const q = getQueue(); q.push({ body, ts: Date.now() }); setQueue(q);
    toast("üîå M·∫•t m·∫°ng ‚Äì ƒë√£ x·∫øp y√™u c·∫ßu v√†o h√†ng ƒë·ª£i", "info");
    return { ok:false, queued:true };
  }
}
setInterval(async () => {
  const q = getQueue(); if (!q.length) return;
  try {
    const r = await apiPost(q[0].body);
    if (r.ok) { q.shift(); setQueue(q); toast("‚úÖ ƒê·ªìng b·ªô th√†nh c√¥ng", "success"); }
  } catch {}
}, 5000);

/* =============== STATE & LOADERS =============== */
const state = {
  products: [],
  orders: [],
  customers: [],
  orderLines: [],
  cacheAt: 0,
};
const CACHE_TTL = 60 * 1000;

async function loadProducts(invalidate=false) {
  const now = Date.now();
  if (!invalidate && state.products.length && now-state.cacheAt<CACHE_TTL) return;
  const rs = await apiGet("SanPham"); const rows = rs.ok?rs.rows:[];
  if (!rows?.length) { state.products=[]; return; }
  const h = rows[0];
  state.products = toObjects(h, rows.slice(1)).map(o => ({
    "M√£ SP": o["M√£ SP"] || o["MaSP"] || "",
    "T√™n s·∫£n ph·∫©m": o["T√™n s·∫£n ph·∫©m"] || o["TenSP"] || "",
    "Size": o["Size"] || "",
    "Gi√°": Number(o["Gi√°"] || o["Gia"] || 0),
  }));
  state.cacheAt = now;
}
async function loadCustomers() {
  const rs = await apiGet("KhachHang"); const rows = rs.ok?rs.rows:[];
  state.customers = rows?.length ? rows.slice(1).map(r=>({
    ma:r[0], ten:r[1], loai:r[2]||"", sdt:r[3]||"", email:r[4]||"", diachi:r[5]||"", ghichu:r[6]||""
  })) : [];
}
async function loadOrders(invalidate=false) {
  const now = Date.now();
  if (!invalidate && state.orders.length && now-state.cacheAt<CACHE_TTL) return;
  const rs = await apiGet("DonHang"); const rows = rs.ok?rs.rows:[];
  if (!rows?.length) { state.orders=[]; return; }
  const h = rows[0];
  state.orders = toObjects(h, rows.slice(1)).map(o => ({
    ma:o["M√£ ƒë∆°n"]||o["MaDon"]||"",
    khach:o["Kh√°ch h√†ng"]||o["KhachHang"]||"",
    ngay:o["Ng√†y t·∫°o"]||o["NgayTao"]||"",
    tong:Number(o["T·ªïng ti·ªÅn"]||o["TongTien"]||0),
    paid:Number(o["Kh√°ch tr·∫£"]||o["KhachTra"]||0),
    debt_after:Number(o["C√≤n n·ª£"]||o["ConNo"]||0),
  }));
  state.cacheAt = now;
}
async function loadOrderDetails(ma) {
  const rs = await apiGet("ChiTietDonHang"); const rows = rs.ok?rs.rows:[];
  if (!rows?.length) return [];
  const h = rows[0];
  return toObjects(h, rows.slice(1))
    .map(o=>({
      ma:o["M√£ ƒë∆°n"]||o["MaDon"]||"",
      ten:o["T√™n s·∫£n ph·∫©m"]||o["TenSP"]||"",
      so_luong:Number(o["S·ªë l∆∞·ª£ng"]||o["SL"]||0),
      don_gia:Number(o["ƒê∆°n gi√°"]||o["DonGia"]||0),
      thanh_tien:Number(o["Th√†nh ti·ªÅn"]||o["ThanhTien"]||0),
    }))
    .filter(x=>x.ma===ma);
}

/* =============== LAYOUT TOGGLE =============== */
function toggleShell(showShell) {
  const sh = shellEl(), app = appEl(); if (!sh || !app) return;
  sh.classList.toggle("hidden", !showShell);
  app.classList.toggle("hidden", showShell);
  if (!showShell) window.scrollTo({ top:0, behavior:"smooth" });
}

/* =============== PAGES =============== */
// Dashboard
async function pageOverview() { appEl().innerHTML = ""; }

/* ---- Customers (create / update / delete) ---- */
async function pageCustomers() {
  toggleShell(false);

  appEl().innerHTML = `
    <div class="page-head"><h1>Qu·∫£n l√Ω Kh√°ch h√†ng</h1></div>
    <div class="card">
      <div class="quick-3">
        <button class="quick big" id="kh-add"><div class="q-icon">üë•‚ûï</div><div>Th√™m kh√°ch h√†ng</div></button>
        <div class="quick big"><div class="q-icon">üîé</div><div><input id="kh-search" class="search w-full" placeholder="T√¨m t√™n, SƒêT, email..."></div></div>
        <button class="quick big" id="kh-export"><div class="q-icon">üìä</div><div>Xu·∫•t b√°o c√°o</div></button>
      </div>
    </div>
    <div class="card"><div class="list-head"><h3 id="kh-count">Danh s√°ch Kh√°ch h√†ng</h3></div><div id="kh-list" class="kh-list"></div></div>

    <div id="kh-modal" class="modal hidden">
      <div class="modal-body">
        <h3 id="kh-title">‚ûï Th√™m kh√°ch h√†ng</h3>
        <input type="hidden" id="m-ma">
        <div class="row">
          <div class="col"><label>T√™n <span class="req">*</span></label><input id="m-ten"></div>
          <div class="col"><label>Lo·∫°i <span class="req">*</span></label>
            <select id="m-loai"><option value="">Ch·ªçn</option><option>C√° nh√¢n</option><option>Doanh nghi·ªáp</option><option>Kh√°c</option></select>
          </div>
        </div>
        <div class="row">
          <div class="col"><label>SƒêT <span class="req">*</span></label><input id="m-sdt"></div>
          <div class="col"><label>Email</label><input id="m-email"></div>
        </div>
        <div><label>ƒê·ªãa ch·ªâ</label><input id="m-diachi"></div>
        <div><label>Ghi ch√∫</label><textarea id="m-ghichu" rows="3"></textarea></div>
        <div class="right" style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn" id="m-cancel">H·ªßy</button>
          <button class="btn primary" id="m-save">L∆∞u</button>
        </div>
      </div>
    </div>
  `;

  const modal = $("#kh-modal");
  const openModal = ()=> modal.classList.remove("hidden");
  const closeModal = ()=> modal.classList.add("hidden");
  const f = { ma:$("#m-ma"), ten:$("#m-ten"), loai:$("#m-loai"), sdt:$("#m-sdt"), email:$("#m-email"), diachi:$("#m-diachi"), ghichu:$("#m-ghichu"), title:$("#kh-title"), save:$("#m-save"), cancel:$("#m-cancel") };
  let mode = "create";
  const initials = name => (String(name||"").split(" ").filter(Boolean).slice(-2).map(s=>s[0]).join("").toUpperCase()) || "KH";

  await loadCustomers(); render("");

  function render(keyword="") {
    const k = keyword.toLowerCase();
    const list = k ? state.customers.filter(x =>
      (x.ten||"").toLowerCase().includes(k) ||
      (x.sdt||"").toLowerCase().includes(k) ||
      (x.email||"").toLowerCase().includes(k)
    ) : state.customers;

    $("#kh-count").textContent = `Danh s√°ch Kh√°ch h√†ng (${list.length})`;
    if (!list.length) { $("#kh-list").innerHTML = `<div class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</div>`; return; }

    $("#kh-list").innerHTML = list.map(x => `
      <div class="kh-card" data-item="${x.ma}">
        <div class="kh-left">
          <div class="avatar">${initials(x.ten)}</div>
          <div class="kh-info">
            <div class="kh-name">${x.ten} <span class="muted">(${x.ma})</span> ${x.loai?`<span class="badge gray">${x.loai}</span>`:""}</div>
            <div class="kh-line">
              ${x.sdt?`<span>üìû ${x.sdt}</span>`:""}
              ${x.email?`<span>‚úâÔ∏è ${x.email}</span>`:""}
              ${x.diachi?`<span>üìç ${x.diachi}</span>`:""}
            </div>
          </div>
        </div>
        <div class="kh-right">
          <div class="kh-actions">
            <button class="btn sm info" data-act="detail" data-id="${x.ma}">Chi ti·∫øt</button>
            <button class="btn sm primary" data-act="edit" data-id="${x.ma}">S·ª≠a</button>
            <button class="btn sm danger" data-act="delete" data-id="${x.ma}">X√≥a</button>
          </div>
        </div>
      </div>
    `).join("");
  }

  $("#kh-search").oninput = e => render(e.target.value || "");
  $("#kh-export").onclick = () => alert("Xu·∫•t tr·ª±c ti·∫øp t·ª´ Google Sheets (b·ªï sung sau).");

  $("#kh-add").onclick = () => {
    mode = "create";
    f.title.textContent = "‚ûï Th√™m kh√°ch h√†ng";
    f.save.textContent  = "Th√™m kh√°ch h√†ng";
    f.ma.value = f.ten.value = f.loai.value = f.sdt.value = f.email.value = f.diachi.value = f.ghichu.value = "";
    openModal();
  };
  f.cancel.onclick = closeModal;

  f.save.onclick = async () => {
    const payload = { ten:f.ten.value.trim(), loai:f.loai.value.trim(), sdt:f.sdt.value.trim(), email:f.email.value.trim(), diachi:f.diachi.value.trim(), ghichu:f.ghichu.value.trim() };
    if (!payload.ten)  return alert("Vui l√≤ng nh·∫≠p T√™n");
    if (!payload.loai) return alert("Vui l√≤ng ch·ªçn Lo·∫°i");
    if (!payload.sdt)  return alert("Vui l√≤ng nh·∫≠p SƒêT");

    let rs;
    if (mode==="create") rs = await safePost({ action:"createCustomer", data: payload });
    else rs = await safePost({ action:"updateCustomer", data:{ ma:f.ma.value, ...payload }});

    if (!rs.ok && !rs.queued) return alert(rs.error || "L·ªói l∆∞u");
    closeModal(); await loadCustomers(); render($("#kh-search").value || "");
    toast(mode==="create" ? (rs.ok?`ƒê√£ t·∫°o KH ${rs.ma_kh||""}`:"ƒê√£ l∆∞u ch·ªù") : (rs.ok?"ƒê√£ c·∫≠p nh·∫≠t":"ƒê√£ l∆∞u ch·ªù"), "success");
  };

  document.addEventListener("click", async (ev) => {
    const b = ev.target.closest(".kh-actions .btn");
    if (!b || !$("#kh-list").contains(b)) return;
    const id = b.dataset.id;
    const row = state.customers.find(x=>x.ma===id);
    const act = b.dataset.act;

    if (act==="detail") {
      alert(`M√£: ${row.ma}
T√™n: ${row.ten}
Lo·∫°i: ${row.loai}
SƒêT: ${row.sdt}
Email: ${row.email}
ƒê·ªãa ch·ªâ: ${row.diachi}
Ghi ch√∫: ${row.ghichu}`);
    }
    if (act==="edit") {
      mode="edit";
      f.title.textContent="‚úèÔ∏è S·ª≠a kh√°ch h√†ng"; f.save.textContent="C·∫≠p nh·∫≠t";
      f.ma.value=row.ma; f.ten.value=row.ten; f.loai.value=row.loai; f.sdt.value=row.sdt; f.email.value=row.email; f.diachi.value=row.diachi; f.ghichu.value=row.ghichu;
      openModal();
    }
    if (act==="delete") {
      if (!confirm(`X√≥a kh√°ch h√†ng ${row.ten} (${row.ma})?`)) return;
      const rs = await safePost({ action:"deleteCustomer", data:{ ma:row.ma }});
      if (!rs.ok && !rs.queued) return alert(rs.error || "Kh√¥ng x√≥a ƒë∆∞·ª£c");
      await loadCustomers(); render($("#kh-search").value || ""); toast(rs.ok?"ƒê√£ x√≥a":"ƒê√£ x·∫øp h√†ng ƒë·ª£i", "success");
    }
  });
}

/* ---- Product ---- */
async function pageProduct() {
  toggleShell(false);

  appEl().innerHTML = `
    <div class="card">
      <h2>üì¶ S·∫£n ph·∫©m</h2>
      <div class="row">
        <div class="col"><label>T√™n</label><input id="sp-ten"></div>
        <div class="col"><label>Size</label><input id="sp-size" placeholder="S/M/L/XL"></div>
      </div>
      <div class="row">
        <div class="col"><label>Gi√° (VND)</label><input id="sp-gia" type="number" value="0"></div>
        <div class="col"></div>
      </div>
      <div style="margin-top:10px"><button class="primary" id="btn-add-sp">üíæ L∆∞u s·∫£n ph·∫©m</button></div>
    </div>
    <div class="card"><h3>üìã Danh s√°ch s·∫£n ph·∫©m</h3><div id="sp-list">ƒêang t·∫£i...</div></div>
  `;

  $("#btn-add-sp").onclick = async () => {
    const ten  = $("#sp-ten").value.trim();
    const size = $("#sp-size").value.trim();
    const gia  = Number($("#sp-gia").value || 0);
    if (!ten || !size || gia<=0) return alert("Thi·∫øu th√¥ng tin");
    const rs = await safePost({ action:"createProduct", data:{ ten, size, gia }});
    if (rs.ok) { toast("ƒê√£ l∆∞u!", "success"); await loadProducts(true); renderList(); $("#sp-ten").value=$("#sp-size").value=""; $("#sp-gia").value=0; }
  };

  await loadProducts(); renderList();
  function renderList() {
    $("#sp-list").innerHTML = renderTableArray(["M√£ SP","T√™n s·∫£n ph·∫©m","Size","Gi√°"], state.products);
  }
}

/* ---- Order (create) ‚Äî c√≥ c√¥ng n·ª£ ---- */
async function pageOrder() {
  toggleShell(false);

  appEl().innerHTML = `
    <div class="card">
      <h2>üßæ T·∫°o ƒë∆°n h√†ng</h2>
      <div class="row">
        <div class="col"><label>Kh√°ch h√†ng</label><input id="dh-khach" placeholder="T√™n KH"></div>
        <div class="col"><label>Ng√†y</label><input id="dh-ngay" value="${todayStr()}"></div>
      </div>
      <div class="row">
        <div class="col"><label>S·∫£n ph·∫©m</label><select id="dh-sp"></select></div>
        <div class="col"><label>S·ªë l∆∞·ª£ng</label><input id="dh-sl" type="number" value="1"></div>
      </div>
      <div class="row">
        <div class="col"><label>ƒê∆°n gi√°</label><input id="dh-gia" type="number" value="0"></div>
        <div class="col"></div>
      </div>
      <div style="margin-top:10px">
        <button class="primary" id="btn-add-line">‚ûï Th√™m v√†o ƒë∆°n</button>
        <button class="danger" id="btn-clear-lines" style="margin-left:8px">üóë Xo√°</button>
      </div>
    </div>

    <div class="card">
      <h3>üìã S·∫£n ph·∫©m trong ƒë∆°n</h3>
      <div id="dh-lines">Ch∆∞a c√≥ d√≤ng</div>

      <div class="row" style="margin-top:10px">
        <div class="col"><label>Kh√°ch tr·∫£ (VND)</label><input id="dh-paid" type="number" value="0"></div>
        <div class="col"><label>Ghi ch√∫</label><input id="dh-note" placeholder="ghi ch√∫..."></div>
      </div>

      <div style="margin-top:10px; display:grid; grid-template-columns: 1fr 1fr; gap: 8px;">
        <div class="muted">üßÆ T·ªïng t·∫°m t√≠nh: <b id="dh-sum">0 VND</b></div>
        <div class="muted right">üì¶ N·ª£ c≈©: <b id="dh-old-debt">0 VND</b></div>
        <div class="muted">üíµ Kh√°ch tr·∫£: <b id="dh-paid-show">0 VND</b></div>
        <div class="muted right">üßæ C√≤n n·ª£ sau Hƒê: <b id="dh-debt-after">0 VND</b></div>
      </div>

      <div style="margin-top:10px"><button class="primary" id="btn-save-order" disabled>‚úÖ L∆∞u ƒë∆°n</button></div>
    </div>
  `;

  await loadProducts();
  const sel = $("#dh-sp");
  sel.innerHTML = (state.products||[]).map(p =>
    `<option value="${p["T√™n s·∫£n ph·∫©m"]}" data-gia="${p["Gi√°"]}">${p["T√™n s·∫£n ph·∫©m"]} ‚Äî ${fmtVND(p["Gi√°"])}</option>`
  ).join("");
  const syncPrice = () => { $("#dh-gia").value = sel.selectedOptions[0]?.getAttribute("data-gia") || 0; };
  syncPrice(); sel.onchange = syncPrice;

  let oldDebt = 0;
  let sum = 0;

  async function refreshDebt() {
    const kh = $("#dh-khach").value.trim();
    if (!kh) { oldDebt = 0; updateTotals(); return; }
    oldDebt = await getDebt(kh); // n·∫øu backend ch∆∞a c√≥ -> 0
    updateTotals();
  }
  $("#dh-khach").addEventListener("change", refreshDebt);
  $("#dh-khach").addEventListener("blur", refreshDebt);

  $("#btn-add-line").onclick = () => {
    const ten = $("#dh-sp").value;
    const sl  = Number($("#dh-sl").value || 0);
    const gia = Number($("#dh-gia").value || 0);
    if (!ten || sl<=0 || gia<=0) return;
    state.orderLines.push({ "T√™n":ten, "S·ªë l∆∞·ª£ng":sl, "ƒê∆°n gi√°":gia, "Th√†nh ti·ªÅn": sl*gia });
    renderLines();
  };
  $("#btn-clear-lines").onclick = () => { state.orderLines=[]; renderLines(); };
  $("#dh-paid").oninput = updateTotals;

  $("#btn-save-order").onclick = async () => {
    const khach = $("#dh-khach").value.trim();
    const ngay  = $("#dh-ngay").value.trim();
    const paid  = Number($("#dh-paid").value || 0);
    const note  = $("#dh-note").value.trim();
    if (!khach || !ngay || !state.orderLines.length) return;

    const total = state.orderLines.reduce((s,x)=>s+x["Th√†nh ti·ªÅn"],0);
    const debt_after = oldDebt + total - paid;

    const details = state.orderLines.map(x=>({ ten:x["T√™n"], so_luong:x["S·ªë l∆∞·ª£ng"], don_gia:x["ƒê∆°n gi√°"] }));

    const rs = await safePost({
      action: "createOrder",
      order: {
        khach, ngay, total, paid,
        debt_before: oldDebt, debt_after,
        note
      },
      details
    });
    alert(rs.ok ? `ƒê√£ l∆∞u ${rs.ma_don}` : "ƒê√£ l∆∞u ch·ªù (offline)");
    state.orderLines=[]; oldDebt=0; $("#dh-khach").value=""; $("#dh-paid").value=0; $("#dh-note").value="";
    renderLines();
  };

  renderLines();

  function updateTotals() {
    sum = state.orderLines.reduce((s,x)=>s+x["Th√†nh ti·ªÅn"],0);
    const paid = Number($("#dh-paid").value || 0);
    const debt_after = oldDebt + sum - paid;
    $("#dh-sum").textContent = fmtVND(sum);
    $("#dh-old-debt").textContent = fmtVND(oldDebt);
    $("#dh-paid-show").textContent = fmtVND(paid);
    $("#dh-debt-after").textContent = fmtVND(debt_after);
  }
  function renderLines() {
    if (!state.orderLines.length) {
      $("#dh-lines").innerHTML = "Ch∆∞a c√≥ d√≤ng";
      $("#btn-save-order").disabled = true;
      updateTotals(); return;
    }
    $("#dh-lines").innerHTML = renderTableArray(["T√™n","S·ªë l∆∞·ª£ng","ƒê∆°n gi√°","Th√†nh ti·ªÅn"], state.orderLines);
    $("#btn-save-order").disabled = false;
    updateTotals();
  }
}

/* ---- Orders view (Chi ti·∫øt c√≥ t·ªïng) ---- */
async function pageOrdersView() {
  toggleShell(false);

  appEl().innerHTML = `
    <div class="card">
      <h2>üìö Qu·∫£n l√Ω ƒë∆°n h√†ng</h2>
      <div class="list-head">
        <input class="search" id="od-search" placeholder="T√¨m theo m√£ ƒë∆°n/kh√°ch">
        <button id="od-reload">üîÑ Refresh</button>
      </div>
    </div>
    <div class="card"><div id="od-table">ƒêang t·∫£i...</div></div>
    <div class="card"><h3>üëÅÔ∏è Chi ti·∫øt</h3><div id="od-detail">Ch·ªçn 1 ƒë∆°n ƒë·ªÉ xem.</div></div>
  `;

  $("#od-reload").onclick = async () => { await loadOrders(true); render(); };
  $("#od-search").oninput = () => render();

  await loadOrders(); render();

  function render() {
    const q = ($("#od-search").value || "").toLowerCase();
    const data = q ? state.orders.filter(o =>
      (o.ma||"").toLowerCase().includes(q) || (o.khach||"").toLowerCase().includes(q)
    ) : state.orders;

    let html = `<table><thead><tr>
      <th>M√£ ƒë∆°n</th><th>Kh√°ch h√†ng</th><th>Ng√†y</th>
      <th class="right">T·ªïng</th><th class="right">Kh√°ch tr·∫£</th><th class="right">C√≤n n·ª£</th><th></th>
    </tr></thead><tbody>`;
    data.forEach(o => {
      html += `<tr>
        <td>${o.ma}</td><td>${o.khach}</td><td>${o.ngay}</td>
        <td class="right">${fmtVND(o.tong)}</td>
        <td class="right">${fmtVND(o.paid)}</td>
        <td class="right">${fmtVND(o.debt_after)}</td>
        <td><button data-view="${o.ma}">Chi ti·∫øt</button></td>
      </tr>`;
    });
    html += `</tbody></table>`;
    $("#od-table").innerHTML = html;

    $$("#od-table [data-view]").forEach(btn=>{
      btn.onclick = async () => {
        const ma = btn.getAttribute("data-view");
        const detail = await loadOrderDetails(ma);
        if (!detail.length) { $("#od-detail").innerHTML = "Kh√¥ng c√≥ chi ti·∫øt."; return; }

        // N·∫øu c·ªôt "Th√†nh ti·ªÅn" tr·∫£ 0, t·ª± t√≠nh t·ª´ SL*ƒê∆°n gi√°
        const rows = detail.map(d=>{
          const tt = d.thanh_tien>0 ? d.thanh_tien : (d.so_luong * d.don_gia);
          return {
            "T√™n s·∫£n ph·∫©m": d.ten,
            "S·ªë l∆∞·ª£ng": d.so_luong,
            "ƒê∆°n gi√°": fmtVND(d.don_gia),
            "Th√†nh ti·ªÅn": fmtVND(tt),
          };
        });
        const total = detail.reduce((s, x) => s + (x.thanh_tien>0 ? x.thanh_tien : x.so_luong*x.don_gia), 0);

        $("#od-detail").innerHTML =
          renderTableArray(["T√™n s·∫£n ph·∫©m","S·ªë l∆∞·ª£ng","ƒê∆°n gi√°","Th√†nh ti·ªÅn"], rows) +
          `<div class="right" style="margin-top:8px;font-weight:700">T·ªïng: ${fmtVND(total)}</div>`;
      };
    });
  }
}

/* ---- Manufacturing ---- */
async function pageManufacturing() {
  toggleShell(false);

  appEl().innerHTML = `
    <div class="card">
      <h2>üßµ S·∫£n xu·∫•t</h2>
      <div class="row">
        <div class="col"><label>M·∫´u (M√£ SP)</label><select id="mo-sp"></select></div>
        <div class="col"><label>Size</label><input id="mo-size" placeholder="S/M/L/XL"></div>
      </div>
      <div class="row">
        <div class="col"><label>M√†u</label><input id="mo-mau"></div>
        <div class="col"><label>S·ªë l∆∞·ª£ng</label><input id="mo-sl" type="number" value="100"></div>
      </div>
      <div style="margin-top:10px"><button class="primary" id="btn-create-mo">T·∫°o l·ªánh</button></div>
    </div>
    <div class="card"><h3>üì¶ Nhu c·∫ßu NVL theo BOM</h3><div id="bom-preview">‚Äî</div></div>
  `;

  const [spRs, bomRs] = await Promise.all([apiGet("SanPham"), apiGet("BOM")]);
  const sp = spRs.ok ? toObjects(spRs.rows[0], spRs.rows.slice(1)) : [];
  const bom = bomRs.ok ? toObjects(bomRs.rows[0], bomRs.rows.slice(1)) : [];

  $("#mo-sp").innerHTML = sp.map(x =>
    `<option value="${x["M√£ SP"]||x["MaSP"]}">${x["M√£ SP"]||x["MaSP"]} - ${x["T√™n s·∫£n ph·∫©m"]||x["TenSP"]||""}</option>`
  ).join("");

  const parseSizeDM = (s) => {
    const map = {};
    String(s||"").split(",").forEach(p => {
      const [a,b] = p.split(":"); if (a&&b) map[a.trim()] = Number(b);
    });
    return map;
  };
  const computeNeed = () => {
    const masp = $("#mo-sp").value;
    const size = $("#mo-size").value.trim();
    const sl   = Number($("#mo-sl").value || 0);
    const lines = bom.filter(r => (r["MaSP"]||r["M√£ SP"])===masp);
    return lines.map(l=>{
      const dm  = parseSizeDM(l["DinhMucTheoSize"]||l["ƒê·ªãnhM·ª©cTheoSize"]||"");
      const hao = Number(l["HaoHut%"]||l["HaoHut"]||0)/100;
      const need = Math.ceil(sl * (dm[size] ?? dm["ALL"] ?? 0) * (1+hao));
      return { MaNVL:l["MaNVL"]||l["M√£ NVL"], SoLuong:need, DonVi:l["DonVi"]||l["ƒê∆°n v·ªã"] };
    }).filter(x=>x.MaNVL);
  };
  const renderPreview = () => { $("#bom-preview").innerHTML = renderTableArray(["MaNVL","SoLuong","DonVi"], computeNeed()); };
  ["change","keyup"].forEach(ev => { $("#mo-size").addEventListener(ev, renderPreview); $("#mo-sl").addEventListener(ev, renderPreview); });
  renderPreview();

  $("#btn-create-mo").onclick = async () => {
    const rs = await safePost({ action:"createMO", data:{
      MaSP:$("#mo-sp").value, Size:$("#mo-size").value.trim(),
      Mau:$("#mo-mau").value.trim(), SoLuong:Number($("#mo-sl").value||0),
    }});
    const need = computeNeed();
    if (need.length) await safePost({ action:"issueMaterial", data:{ MaLenh: rs.MaLenh||"MO-PENDING", items: need }});
    alert(`ƒê√£ t·∫°o ${rs.MaLenh||"(ch·ªù ƒë·ªìng b·ªô)"} & xu·∫•t NVL theo BOM`);
  };
}

/* ---- Timesheet ---- */
async function pageTimesheet() {
  toggleShell(false);

  const cdRs = await apiGet("CongDoan");
  const cds = cdRs.ok ? toObjects(cdRs.rows[0], cdRs.rows.slice(1)) : [];

  appEl().innerHTML = `
    <div class="card"><h2>üìù Ch·∫•m c√¥ng c√¥ng ƒëo·∫°n</h2>
      <div class="row">
        <div class="col"><label>Ng√†y</label><input id="cc-ngay" value="${todayStr()}"></div>
        <div class="col"><label>M√£ CN</label><input id="cc-macn"></div>
      </div>
      <div class="row">
        <div class="col"><label>T√™n CN</label><input id="cc-tencn"></div>
        <div class="col"><label>M√£ L·ªánh</label><input id="cc-molenh"></div>
      </div>
      <div class="row">
        <div class="col"><label>C√¥ng ƒëo·∫°n</label>
          <select id="cc-cd">${cds.map(c=>`<option>${c["TenCD"]||c["T√™n CD"]||c["T√™n c√¥ng ƒëo·∫°n"]||""}</option>`)}</select>
        </div>
        <div class="col"><label>SL</label><input id="cc-sl" type="number" value="10"></div>
      </div>
      <div style="margin-top:10px"><button class="primary" id="btn-cc">Ghi c√¥ng</button></div>
    </div>
  `;
  $("#btn-cc").onclick = async () => {
    const d = { Ngay:$("#cc-ngay").value, MaCN:$("#cc-macn").value, TenCN:$("#cc-tencn").value, MaLenh:$("#cc-molenh").value, CongDoan:$("#cc-cd").value, SL:Number($("#cc-sl").value||0) };
    const rs = await safePost({ action:"recordTimesheet", data:d });
    alert(rs.ok?"ƒê√£ ghi c√¥ng!":"ƒê√£ l∆∞u ch·ªù (offline)");
  };
}

/* ---- Payroll ---- */
async function pagePayroll() {
  toggleShell(false);

  appEl().innerHTML = `
    <div class="card"><h2>üí∞ T√≠nh l∆∞∆°ng</h2>
      <div class="row">
        <div class="col"><label>Th√°ng</label><input id="pl-thang" value="${todayStr().slice(0,7)}"></div>
        <div class="col" style="display:flex;align-items:flex-end"><button class="primary" id="btn-calc">T√≠nh</button></div>
      </div>
      <div id="pl-result" style="margin-top:10px"></div>
    </div>
  `;
  $("#btn-calc").onclick = async () => {
    const thang = $("#pl-thang").value;
    const rs = await safePost({ action:"calcPayroll", data:{ thang }});
    $("#pl-result").innerHTML = rs.ok ? `‚úÖ ƒê√£ ghi ${rs.rows} d√≤ng v√†o BangLuong` : `‚ö†Ô∏è ƒê√£ x·∫øp y√™u c·∫ßu v√†o h√†ng ƒë·ª£i (offline)`;
  };
}

/* =============== ROUTER =============== */
function setActive(page) { $$(".menu-item,[data-page]").forEach(el=>{ if (el.dataset?.page) el.classList.toggle("active", el.dataset.page===page); }); }
async function loadPage(page) {
  setActive(page);
  if (page==="overview") { toggleShell(true); return pageOverview(); }
  toggleShell(false);
  if (page==="customers")     return pageCustomers();
  if (page==="product")       return pageProduct();
  if (page==="order")         return pageOrder();
  if (page==="orders_view")   return pageOrdersView();
  if (page==="manufacturing") return pageManufacturing();
  if (page==="timesheet")     return pageTimesheet();
  if (page==="payroll")       return pagePayroll();
  toggleShell(true); return pageOverview();
}

/* =============== GLOBAL =============== */
document.addEventListener("click", (e)=>{
  const el = e.target.closest("[data-page]"); if (!el) return;
  e.preventDefault(); const page = el.dataset.page; if (page) loadPage(page);
});
window.addEventListener("DOMContentLoaded", ()=>{
  if (!$("#app")) { const m=document.createElement("main"); m.id="app"; document.body.appendChild(m); }
  toggleShell(true); loadPage("overview");
});
